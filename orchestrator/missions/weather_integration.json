{
  "name": "Weather Module Integration",
  "description": "Integrate the standalone harris_farm_weather module into the Hub dashboards. Currently the weather system runs independently. Connect it to the Buying Hub dashboard so buyers see weather-adjusted demand forecasts alongside category data.",
  "abort_on_safety_fail": true,
  "max_retries_per_task": 1,
  "timeout_seconds_per_task": 600,
  "phases": [
    {
      "name": "Create weather API endpoints",
      "success_criteria": "Backend serves weather data via API. Tests pass.",
      "tasks": [
        {
          "name": "Add weather API endpoints to backend",
          "description": "In backend/app.py, add endpoints to serve weather data from harris_farm_weather/weather.db:\n\n1. GET /api/weather/forecast?store_id={id}&days={n}\n   - Query weather.db for weather forecasts for the store's location\n   - Return: date, temp_max, temp_min, rain_mm, condition, wind_kph\n   - Default days=7\n\n2. GET /api/weather/demand-adjustments?store_id={id}&days={n}\n   - Use the WeatherDemandPlanner from harris_farm_weather/weather_demand_planner.py\n   - Return: product_id, product_name, category, base_demand, adjusted_demand, multiplier, weather_condition\n   - Shows how weather impacts demand for weather-sensitive products\n\n3. GET /api/weather/alerts?store_id={id}\n   - Return active buying alerts: products that need ordering adjustments due to upcoming weather\n   - Include: product, store, alert_type (increase/decrease), multiplier, reason, days_ahead\n\n4. GET /api/weather/stores\n   - Return stores with GPS coordinates from weather.db\n\nThe weather.db is at harris_farm_weather/weather.db relative to project root.\nImport from harris_farm_weather: sys.path.insert(0, os.path.join(PROJECT_ROOT, 'harris_farm_weather'))\n\nIf weather.db doesn't exist or is empty, return empty results with a message (don't crash).\n\nRun tests after: python3 -m pytest tests/ -v",
          "agent_role": "backend_engineer",
          "files_to_touch": [
            "backend/app.py"
          ]
        }
      ]
    },
    {
      "name": "Add weather to Buying Hub dashboard",
      "success_criteria": "Buying Hub shows weather forecasts and demand adjustments. Tests pass.",
      "tasks": [
        {
          "name": "Integrate weather into Buying Hub dashboard",
          "description": "In dashboards/buying_hub_dashboard.py, add a Weather Impact section:\n\n1. Add a 'Weather Impact' tab or section:\n   - 7-day weather forecast for selected store (from /api/weather/forecast)\n   - Display as a weather card row: date, icon (sun/rain/cloud emoji), temp range, rain\n\n2. Demand Adjustment Table:\n   - Query /api/weather/demand-adjustments for selected store\n   - Table columns: Product | Category | Base Demand | Weather Adjusted | Multiplier | Reason\n   - Highlight rows with multiplier > 1.3 (green, order more) or < 0.7 (red, order less)\n   - Sort by largest adjustment impact\n\n3. Buying Alerts Panel:\n   - Query /api/weather/alerts for selected store\n   - Display as st.warning/st.info cards:\n     'ðŸŒ§ï¸ Rain forecast Wednesday: Reduce salad orders by 20% at Mosman'\n     'â˜€ï¸ Heat wave Friday: Increase ice cream orders by 50% at Bondi'\n\n4. Weekly Weather vs Sales Chart:\n   - If historical weather and sales data available, show correlation\n   - Plotly dual-axis chart: temperature line + sales bars\n\nIf weather API returns empty (no weather.db), show a message: 'Weather data not configured. Run harris_farm_weather/install.sh to set up.'\n\nKeep existing Buying Hub content intact. Add weather as a new section.\n\nRun tests after: python3 -m pytest tests/ -v",
          "agent_role": "frontend_engineer",
          "files_to_touch": [
            "dashboards/buying_hub_dashboard.py"
          ]
        }
      ]
    },
    {
      "name": "Tests and docs",
      "success_criteria": "Weather integration tests pass. Docs updated.",
      "tasks": [
        {
          "name": "Write weather integration tests and update docs",
          "description": "1. Create tests/test_weather_integration.py:\n   - Test GET /api/weather/forecast returns list (even if empty)\n   - Test GET /api/weather/demand-adjustments returns list\n   - Test GET /api/weather/alerts returns list\n   - Test GET /api/weather/stores returns list\n   - Test weather endpoint handles missing weather.db gracefully (no crash)\n   - Test demand multiplier is positive number\n   - Test alert has required fields (product, alert_type, multiplier)\n   - Min 8 tests\n\n2. Update docs/FEATURE_STATUS.md â€” add Weather Integration section as LIVE\n3. Update docs/CHANGELOG.md\n4. Update docs/ARCHITECTURE.md â€” add weather module to system diagram\n\nRun: python3 -m pytest tests/ -v",
          "agent_role": "test_engineer",
          "files_to_touch": [
            "tests/test_weather_integration.py",
            "docs/FEATURE_STATUS.md",
            "docs/CHANGELOG.md",
            "docs/ARCHITECTURE.md"
          ]
        }
      ]
    }
  ]
}
