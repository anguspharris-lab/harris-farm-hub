{
  "name": "Role-Based Access Control Enforcement",
  "description": "Enforce RBAC on all API endpoints. User roles exist in auth system but are not enforced. Add role checking middleware, protect admin endpoints, and restrict data access by role.",
  "abort_on_safety_fail": true,
  "max_retries_per_task": 1,
  "timeout_seconds_per_task": 600,
  "phases": [
    {
      "name": "Define roles and create middleware",
      "success_criteria": "Role definitions and auth middleware in place. Tests pass.",
      "tasks": [
        {
          "name": "Create RBAC middleware and role definitions",
          "description": "In backend/auth.py (or a new backend/rbac.py if cleaner):\n\n1. Define roles:\n   ROLES = {\n     'admin': {'level': 100, 'description': 'Full access to all endpoints'},\n     'operator': {'level': 80, 'description': 'Can approve/reject proposals, run executor'},\n     'analyst': {'level': 60, 'description': 'Can view dashboards, run queries, submit tasks'},\n     'viewer': {'level': 40, 'description': 'Read-only access to dashboards'},\n   }\n\n2. Create a FastAPI dependency function:\n   def require_role(min_role: str):\n       async def _check(request: Request):\n           # Get session token from cookie or Authorization header\n           # Look up user and their role\n           # If no auth or insufficient role, raise HTTPException(403)\n           # If AUTH_ENABLED=false in .env, skip check (backward compatible)\n       return Depends(_check)\n\n3. Define endpoint-to-role mapping:\n   ENDPOINT_ROLES = {\n     '/api/admin/*': 'admin',\n     '/api/agent-tasks': 'analyst',  # POST\n     '/api/agent-tasks': 'viewer',   # GET\n     '/api/intelligence/*': 'analyst',\n     '/api/portal/*': 'viewer',\n     '/api/auth/admin/*': 'admin',\n     '/api/transactions/*': 'viewer',\n     '/api/query': 'analyst',\n     '/api/rubric': 'analyst',\n   }\n\n4. Ensure backward compatibility: if AUTH_ENABLED env var is 'false' or not set, all checks pass (no breaking change for current setup)\n\nRun tests after: python3 -m pytest tests/ -v",
          "agent_role": "backend_engineer",
          "files_to_touch": [
            "backend/auth.py",
            "backend/app.py"
          ]
        }
      ]
    },
    {
      "name": "Apply RBAC to endpoints",
      "success_criteria": "All admin endpoints require admin role. All write endpoints require analyst+. Tests pass.",
      "tasks": [
        {
          "name": "Apply role requirements to API endpoints",
          "description": "In backend/app.py, add the require_role dependency to protected endpoints:\n\n1. Admin endpoints (require 'admin' role):\n   - All /api/admin/* endpoints\n   - All /api/auth/admin/* endpoints\n   - POST /api/admin/executor/run\n   - POST /api/admin/trigger-analysis\n\n2. Analyst endpoints (require 'analyst' role):\n   - POST /api/query\n   - POST /api/rubric\n   - POST /api/agent-tasks\n   - POST /api/intelligence/run/*\n   - POST /api/decision\n   - POST /api/feedback\n\n3. Viewer endpoints (require 'viewer' role — effectively just needs valid session):\n   - GET /api/transactions/*\n   - GET /api/products/*\n   - GET /api/fiscal-calendar/*\n   - GET /api/portal/*\n   - GET /api/agent-tasks\n   - GET /api/intelligence/*\n   - GET /api/templates\n\n4. Public endpoints (no auth required):\n   - GET / (root health check)\n   - POST /api/auth/login\n   - POST /api/auth/register\n   - GET /api/auth/site-password-check\n\nAdd the dependency like: @app.post('/api/admin/executor/run', dependencies=[require_role('admin')])\n\nIMPORTANT: All role checks must be skipped when AUTH_ENABLED is false. Do NOT break the current no-auth setup.\n\nRun tests after: python3 -m pytest tests/ -v",
          "agent_role": "backend_engineer",
          "files_to_touch": [
            "backend/app.py"
          ]
        }
      ]
    },
    {
      "name": "Tests and docs",
      "success_criteria": "RBAC tests pass. Docs updated.",
      "tasks": [
        {
          "name": "Write RBAC tests and update docs",
          "description": "1. Create tests/test_rbac.py:\n   - Test role hierarchy: admin > operator > analyst > viewer\n   - Test admin endpoint returns 403 without admin session\n   - Test admin endpoint succeeds with admin session\n   - Test analyst endpoint returns 403 for viewer role\n   - Test public endpoints work without auth\n   - Test backward compatibility: all endpoints work when AUTH_ENABLED=false\n   - Test role assignment on user creation\n   - Min 10 tests\n\n2. Update docs/FEATURE_STATUS.md:\n   - Role-Based Access Control: PLANNED → LIVE\n\n3. Update docs/CHANGELOG.md\n\nRun: python3 -m pytest tests/ -v",
          "agent_role": "test_engineer",
          "files_to_touch": [
            "tests/test_rbac.py",
            "docs/FEATURE_STATUS.md",
            "docs/CHANGELOG.md"
          ]
        }
      ]
    }
  ]
}
